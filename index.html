<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebop Blueprint</title>
    <link rel="icon" type="image/png" href="es335icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1f618d;
        }
        .app-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fretboards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .fretboard-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .scale-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .fretboard {
            position: relative;
            height: 200px;
            background-color: #FFCF79;
            border-radius: 5px;
            margin-bottom: 30px;
            border: 2px solid #4B1C2E;
            overflow: visible;
        }
        .fret-line {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #c0c0c0;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 1;
        }
        .string-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: silver;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 0;
        }
        .fret-number {
            position: absolute;
            bottom: -40px;
            font-size: 16px;
            color: #1f618d;
            transform: translateX(-50%);
            font-weight: bold;
            z-index: 2;
            width: 20px;
            text-align: center;
        }
        .fret-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #333;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .note {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            z-index: 3;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }
        .note:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        .beat {
            width: 40px;
            height: 80px;
            background: #9E9E9E;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 14px;
            margin: 0 2px;
        }
        .beats-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: nowrap;
        }
        .beat.active {
            transform: translateY(-10px);
        }
        #measures {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .measure {
            position: relative;
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }
        .measure.dragging {
            opacity: 0.5;
        }
        .measure.active {
            background-color: #c3e6cb;
            border: 2px solid #28a745;
        }
        .measure-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #333;
        }
        .chord-controls, .scale-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .chord-controls select, .scale-controls select {
            flex: 1;
        }
        @media (max-width: 1200px) {
            #measures {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            #measures {
                grid-template-columns: 1fr;
            }
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        select {
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        #tempo-display {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 10px;
        }
        #loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            z-index: 1000;
        }
        .checkbox-wrapper {
            margin-top: 20px;
            margin-left: 20px;
            display: flex;
            align-items: center;
        }
        .control-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .control-button:hover {
            background: #45a049;
        }
        #chordsEnabled {
            margin-bottom: 10px;
            padding: 8px 16px;
        }
        body.dark-mode {
            background-color: #283618;
            color: #fefae0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode .app-section {
            background: linear-gradient(145deg, #283618, #606c38);
            color: #fefae0;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .fretboard-container {
            background-color: #606c38;
            border: 1px solid #dda15e;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .dark-mode .fretboard {
            background-color: #dda15e;
            border: 2px solid #4b4b4b;
            border-radius: 5px;
        }
        .dark-mode .note {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .note:hover {
            transform: scale(1.2);
            background-color: #bc6c25;
        }
        .dark-mode .scale-display {
            color: #fefae0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .dark-mode button {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode button:hover {
            background-color: #bc6c25;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .dark-mode select {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
        }
        .dark-mode select:hover {
            background-color: #bc6c25;
        }
        .dark-mode .measure {
            background-color: #606c38;
            color: #fefae0;
            border: 1px solid #dda15e;
        }
        .dark-mode .measure.active {
            background-color: #dda15e;
            border-color: #bc6c25;
        }
        .dark-mode .beat {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .beat.active {
            background-color: #bc6c25;
            transform: translateY(-5px);
        }
        .dark-mode .volume-control {
            color: #fefae0;
        }
        .dark-mode .volume-control input[type="range"] {
            background: #606c38;
        }
        .dark-mode .volume-control input[type="range"]::-webkit-slider-thumb {
            background: #dda15e;
            border: 1px solid #bc6c25;
        }
        #dark-mode-toggle.active {
            background-color: #283618;
            color: #fefae0;
            border: 1px solid #dda15e;
        }
    </style>
</head>
<body>
    <div class="app-section" id="chord-fretboard-section">
        <h1>BEBOP BLUEPRINT</h1>
        <h3>Fretflow - Dynamic Fretboard with Scales that Move with the Chord Progression</h3>
        <button id="dark-mode-toggle" aria-label="Toggle dark mode">Dark Mode</button>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="chord-fretboard-volume" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div class="fretboard-container">
            <div class="scale-display" id="scale-display"></div>
            <div class="controls">
                <select class="tuning-select" id="chord-tuning" aria-label="Select guitar tuning">
                    <option value="standard">Standard (EADGBE)</option>
                    <option value="dropD">Drop D (DADGBE)</option>
                    <option value="openG">Open G (DGDGBD)</option>
                    <option value="DADGAD">DADGAD</option>
                    <option value="openE">Open E (EBEG#BE)</option>
                </select>
            </div>
            <div id="chord-fretboard" class="fretboard"></div>
        </div>
    </div>

    <div class="app-section" id="metronome-section">
        <h2>BeatForge Metronome</h2>
        <h3>Click to accent strong beats</h3>
        <div class="controls">
            <select id="time-signature" aria-label="Select time signature">
                <option value="2">2/4</option>
                <option value="3">3/4</option>
                <option value="4" selected>4/4</option>
                <option value="6">6/8</option>
                <option value="7">7/8</option>
                <option value="8">8/8</option>
                <option value="12">12/8</option>
            </select>
            <select id="sound-type" aria-label="Select metronome sound">
                <option value="click">Click</option>
                <option value="woodblock">Woodblock</option>
                <option value="drums">Drums</option>
            </select>
            <button id="drumSetToggleBtn" class="control-button">Drums</button>
            <div class="volume-control">
                <span>Metronome Volume:</span>
                <input type="range" id="metronome-volume" min="0" max="1" step="0.1" value="0.25" aria-label="Metronome volume">
            </div>
            <input type="range" id="tempo" min="40" max="220" value="120" aria-label="Tempo">
            <span id="tempo-display">120 BPM</span>
            <button id="tap-tempo" aria-label="Tap tempo">Tap Tempo</button>
            <button id="start-stop" aria-label="Start or stop metronome">Start</button>
        </div>
        <div class="beats-container"></div>
    </div>

    <div class="volume-control">
        <label for="accent-intensity">Accent Intensity:</label>
        <input type="range" id="accent-intensity" min="1" max="2" step="0.1" value="1.5" aria-label="Accent intensity">
    </div>
    
    <div class="app-section" id="chord-progression-section">
        <h2>Chord Progression Practice</h2>
        <h3>Create a progression or pick one from the dropdown. Choose which key and scale to go with it.</h3>
        <label for="progression-select">Select Progression:</label>
        <select id="progression-select" aria-label="Select chord progression">
            <option value="I V7">I-V7</option>
            <option value="jazz_blues">Jazz Blues</option>
            <option value="minor_blues">Minor Blues</option>
            <option value="rhythm_changes">Rhythm Changes</option>
            <option value="2_5_1">II-V-I</option>
            <option value="6_2_5_1">VI-II-V-I</option>
            <option value="minor_2_5_1">Minor iim-V7-im</option>
            <option value="dark_eyes">Dark Eyes</option>
            <option value="ill_see_you_in_my_dreams">I'll See You In My Dreams</option>
            <option value="rose_room">Rose Room</option>
            <option value="black_orpheus">Black Orpheus</option>
            <option value="all_the_things_you_are">All The Things You Are</option>
            <option value="all_of_me">All of Me</option>
            <option value="stella_by_starlight">Stella By Starlight</option>
            <option value="autumn_leaves">Autumn Leaves</option>
            <option value="summertime">Summertime</option>
            <option value="girl_from_ipanema">Girl From Ipanema</option>
            <option value="coltrane_changes">Coltrane Changes</option>
            <option value="bird_blues">Bird Blues</option>
            <option value="just_friends">Just Friends</option>
            <option value="blue_bossa">Blue Bossa</option>
            <option value="on_green_dolphin_street">On Green Dolphin Street</option>
            <option value="solar">Solar</option>
            <option value="misty">Misty</option>
            <option value="days_of_wine_and_roses">Days of Wine and Roses</option>
            <option value="cherokee">Cherokee</option>
            <option value="caravan">Caravan</option>
            <option value="nows_the_time">Now's The Time</option>
            <option value="tenor_madness">Tenor Madness</option>
        </select>
        <label for="keySelect">Select Key:</label>
        <select id="keySelect" aria-label="Select key">
            <option value="C">C</option>
            <option value="Db">Db</option>
            <option value="D">D</option>
            <option value="Eb">Eb</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="Gb">Gb</option>
            <option value="G">G</option>
            <option value="Ab">Ab</option>
            <option value="A">A</option>
            <option value="Bb">Bb</option>
            <option value="B">B</option>
        </select>
        <div id="measures">
            <!-- Measures will be populated dynamically -->
        </div>
        <button onclick="addMeasure()" aria-label="Add measure">Add Measure</button>
        <button onclick="removeMeasure()" aria-label="Remove measure">Remove Measure</button>
        <div class="checkbox-wrapper">
            <button id="chordsEnabled" class="toggle-button active">Chords Enabled</button>
        </div>
        <div class="volume-control">
            <label for="chord-volume">Chord Volume:</label>
            <input type="range" id="chord-volume" min="0" max="1" step="0.1" value="0.75" aria-label="Chord volume">
        </div>
    </div>

    <div class="app-section" id="fretflow-section">
        <h2>FretFlow</h2>
        <h3>Multiple scale workout</h3>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="fretboard-volume" min="0" max="1" step="0.1" value="0.3" aria-label="Fretboard volume">
        </div>
        <div class="fretboards-grid"></div>
    </div>

    <script>
        // Utility Functions
        function log(message) {
            console.log(`[FretFlow Debug] ${message}`);
        }

        function updateLoadingStatus(message) {
            let indicator = document.getElementById('loading-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loading-indicator';
                document.body.appendChild(indicator);
            }
            indicator.textContent = message;
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function flattenNote(note) {
            const flatMap = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
            return flatMap[note] || note;
        }

        // Musical Constants
        const NOTES = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        const ENHARMONIC_MAP = {
            'C#': 'Db', 'Db': 'Db',
            'D#': 'Eb', 'Eb': 'Eb',
            'F#': 'Gb', 'Gb': 'Gb',
            'G#': 'Ab', 'Ab': 'Ab',
            'A#': 'Bb', 'Bb': 'Bb',
            'Ds': 'Eb',
            'Fs': 'Gb'
        };

        const SAMPLE_NOTE_MAP = {
            'Gb': 'Fs', 'Eb': 'Ds', 'F#': 'Fs', 'D#': 'Ds'
        };

        const SAMPLED_NOTES = ['A', 'C', 'Ds', 'Fs'];
        const PIANO_CONFIG = {
            octaves: {
                'A': [2, 3, 4, 5, 6],
                'C': [2, 3, 4, 5, 6],
                'Fs': [2, 3, 4, 5, 6],
                'Ds': [2, 3, 4, 5, 6]
            },
            velocities: [12],
            fileFormat: 'ogg'
        };

        const PIANO_NOTES = {
            'A2': 110.00, 'As2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'Cs3': 138.59, 'D3': 146.83, 'Ds3': 155.56, 'E3': 164.81, 'F3': 174.61,
            'Fs3': 185.00, 'G3': 196.00, 'Gs3': 207.65, 'A3': 220.00, 'As3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'Cs4': 277.18, 'D4': 293.66, 'Ds4': 311.13, 'E4': 329.63
        };

        const FRETBOARD_FREQUENCIES = {
            'string6': [82.41, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81],
            'string5': [110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00],
            'string4': [146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66],
            'string3': [196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00],
            'string2': [246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88],
            'string1': [329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88, 523.25, 554.37, 587.33, 622.25, 659.25]
        };

        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            melodicMinor: [0, 2, 3, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            bebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
            bebopMajor: [0, 2, 4, 5, 7, 8, 9, 11],
            bebopDorian: [0, 2, 3, 4, 5, 7, 9, 10],
            bebopPhrygian: [0, 1, 2, 3, 5, 7, 8, 10],
            altered: [0, 1, 3, 4, 6, 8, 10],
            lydianDominant: [0, 2, 4, 6, 7, 9, 10],
            diminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
            diminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
            wholeHalf: [0, 2, 4, 6, 8, 10],
            pentatonicMajor: [0, 2, 4, 7, 9],
            pentatonicMinor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10],
            majorBlues: [0, 2, 3, 4, 7, 9],
            harmonicMajor: [0, 2, 4, 5, 7, 8, 11],
            doubleHarmonic: [0, 1, 4, 5, 7, 8, 11],
            enigmatic: [0, 1, 4, 6, 8, 10, 11],
            persian: [0, 1, 4, 5, 6, 8, 11],
            arabic: [0, 2, 4, 5, 6, 8, 10],
            japanese: [0, 2, 5, 7, 8],
            egyptian: [0, 2, 5, 7, 10]
        };

        const TUNINGS = {
            standard: ['E', 'B', 'G', 'D', 'A', 'E'],
            dropD: ['E', 'B', 'G', 'D', 'A', 'D'],
            openG: ['D', 'B', 'G', 'D', 'G', 'D'],
            DADGAD: ['D', 'A', 'G', 'D', 'A', 'D'],
            openE: ['E', 'B', 'E', 'Ab', 'B', 'E']
        };

        const DRUM_PATTERNS = {
            '2': { kick: [1, 0], snare: [0, 1], hihat: [1, 1] },
            '3': { kick: [1, 0, 0], snare: [0, 1, 0], hihat: [1, 1, 1] },
            '4': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
            '6': { kick: [1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1] },
            '7': { kick: [1, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1] },
            '8': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
            '12': { kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1] }
        };

        const drumSoundSets = [
            {
                name: "Drums Drums",
                snare: "Snare.wav",
                hihat: "HiHat.wav",
                kick: "Kick.wav"
            },
            {
                name: "Makaya Drums",
                snare: "Snare2.wav",
                hihat: "HiHat2.wav",
                kick: "Kick2.wav"
            },
            {
                name: "Max Drums",
                kick: 'jazzkick.wav',
                snare: 'jazzsnare.wav',
                hihat: 'jazzhat.wav'
            }
        ];

        let currentDrumSetIndex = 0;

        const INTERVAL_MAP = {
            'major': [0, 4, 7],
            'minor': [0, 3, 7],
            'dom7': [0, 4, 7, 10],
            'maj7': [0, 4, 7, 11],
            'min7': [0, 3, 7, 10],
            'min7b5': [0, 3, 6, 10],
            'dim': [0, 3, 6],
            'dim7': [0, 3, 6, 9],
            'aug': [0, 4, 8],
            'sus4': [0, 5, 7],
            'sus2': [0, 2, 7],
            '6': [0, 4, 7, 9],
            'm6': [0, 3, 7, 9],
            '9': [0, 4, 7, 10, 14],
            'maj9': [0, 4, 7, 11, 14],
            'min9': [0, 3, 7, 10, 14]
        };

        const progressions = {
            "I V7": { defaultKey: "C", progression: ["I", "V7"] },
            "jazz_blues": { defaultKey: "Bb", progression: ["I7", "IV7", "I7", "I7", "IV7", "IV7", "I7", "VI7", "IIm7", "V7", "I7", "V7"] },
            "minor_blues": { defaultKey: "Am", progression: ["im7", "ivm7", "im7", "im7", "ivm7", "ivm7", "im7", "im7", "V7", "V7", "im7", "V7"] },
            "rhythm_changes": { defaultKey: "Bb", progression: ["Imaj6", "vim7", "iim7", "V7", "Imaj6", "vim7", "iim7", "V7", "Imaj6", "IV7", "Imaj6", "Imaj6", "iim7", "V7", "Imaj6", "V7"] },
            "2_5_1": { defaultKey: "C", progression: ["iim7", "V7", "Imaj7", "Imaj7"] },
            "6_2_5_1": { defaultKey: "C", progression: ["vim7", "iim7", "V7", "Imaj7", "Imaj7"] },
            "minor_2_5_1": { defaultKey: "Am", progression: ["iim7b5", "V7b9", "im7", "im7"] },
            "dark_eyes": { defaultKey: "Dm", progression: ["V7", "V7", "im7", "im7", "V7", "V7", "VImaj6", "VImaj6", "ivm6", "ivm6", "im7", "im7", "V7", "V7", "im7", "im7"] },    
            "ill_see_you_in_my_dreams": { defaultKey: "F", progression: ["IV6", "IV6", "ivm6", "ivm6", "Imaj7", "VII7", "Imaj7", "Imaj7", "VI7", "VI7", "VI7", "VI7", "II7", "II7", "iim7", "V7", "Imaj7"] },
            "rose_room": {defaultKey: "Ab", progression: ["II7", "V7", "Imaj6", "I7", "IV6", "ivm7", "bVII7", "Imaj6", "VI7", "V7", "V7", "II7", "V7", "Imaj6", "I7", "IV6", "ivm7", "bVII7", "Imaj6", "VI7", "IV7", "V7", "Imaj6", "VI7"] },
            "black_orpheus": { defaultKey: "Am", progression: ["im7", "iim7b5", "V7b9", "im7", "ivm7", "VII7", "bIIImaj7", "bVImaj7", "iim7b5", "V7b9", "im7", "iim7b5", "V7b9", "im7", "ivm7", "VII7"] },
            "all_the_things_you_are": { defaultKey: "Ab", progression: ["vim7", "iim7", "V7", "Imaj7", "IVmaj7", "iiim7", "VI7", "IImaj7", "iim7", "vm7", "I7", "IVmaj7", "Imaj7", "iim7", "V7", "Imaj7", "iim7", "V7", "Imaj7", "iim7", "vm7", "I7", "IVmaj7", "Imaj7"] },
            "all_of_me": { defaultKey: "C", progression: ["Imaj7", "III7", "VI7", "iim7", "III7", "vim7", "II7", "iim7", "V7", "Imaj7", "III7", "VI7", "iim7", "IV", "iv", "Imaj7", "V7"] },
            "stella_by_starlight": { defaultKey: "Bb", progression: ["iim7b5", "V7b9", "im7", "IV7", "vm7", "I7", "IVmaj7", "bVIImaj7", "iiim7b5", "VI7b9", "iim7", "V7", "im7", "IV7", "IVmaj7", "V7"] },
            "autumn_leaves": { defaultKey: "Em", progression: ["ivm7", "VII7", "bIIImaj7", "bVImaj7", "iim7b5", "V7b9", "im7", "im7"] },
            "summertime": { defaultKey: "Am", progression: ["im7", "V7", "im7", "V7", "im7", "V7", "im7", "V7", "iv7", "im7", "V7", "im7", "iv7", "im7", "V7", "im7"] },
            "girl_from_ipanema": { defaultKey: "F", progression: ["Imaj7", "II7", "iim7", "V7", "Imaj7", "II7", "iim7", "V7", "Imaj7", "bII7", "IV#maj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7"] },
            "coltrane_changes": { defaultKey: "C", progression: ["Imaj7", "bIII7", "bVImaj7", "VII7", "IIImaj7", "V7", "Imaj7", "bIII7", "bVImaj7", "VII7", "IIImaj7", "V7"] },
            "bird_blues": { defaultKey: "F", progression: ["I7", "IV7", "I7", "vim7", "iim7", "V7", "IV7", "ivm7", "I7", "vim7", "iim7", "V7"] },
            "just_friends": { defaultKey: "G", progression: ["Imaj7", "VI7", "iim7", "V7", "Imaj7", "VI7", "iim7", "V7", "iim7", "V7", "Imaj7", "VI7", "iim7", "V7", "Imaj7", "VI7"] },
            "blue_bossa": { defaultKey: "Cm", progression: ["im7", "im7", "bVII7", "bVII7", "im7", "im7", "ivm7", "bVII7", "im7", "V7", "im7", "im7"] },
            "on_green_dolphin_street": { defaultKey: "C", progression: ["Imaj7", "bIII7", "bVImaj7", "iim7", "V7", "Imaj7", "bIII7", "bVImaj7", "iim7", "V7", "Imaj7"] },
            "solar": { defaultKey: "C", progression: ["im7", "im7", "bIIImaj7", "bIIImaj7", "bVImaj7", "bVImaj7", "bII7", "bII7", "im7", "im7"] },
            "misty": { defaultKey: "Eb", progression: ["Imaj7", "I7", "IVmaj7", "ivm7", "Imaj7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7"] },
            "days_of_wine_and_roses": { defaultKey: "F", progression: ["Imaj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7"] },
            "cherokee": { defaultKey: "Bb", progression: ["Imaj7", "Imaj7", "iim7", "V7", "Imaj7", "Imaj7", "iim7", "V7","bVI7", "bVI7", "V7", "V7", "Imaj7", "Imaj7", "iim7", "V7"] },
            "caravan": { defaultKey: "Eb", progression: ["im7", "IV7", "im7", "IV7", "im7", "IV7", "im7", "IV7", "bVII7", "bVII7", "Imaj7", "Imaj7", "V7", "V7", "im7", "im7"] },
            "nows_the_time": { defaultKey: "F", progression: ["I7", "I7", "I7", "I7", "IV7", "IV7", "I7", "I7", "V7", "IV7", "I7", "I7"] },
            "tenor_madness": { defaultKey: "Bb", progression: ["I7", "I7", "I7", "I7", "IV7", "IV7", "I7", "I7", "iim7", "V7", "I7", "I7"] }
        };

        const scaleDegrees = {
            major: {
                'I': 0, 'II': 2, 'III': 4, 'IV': 5, 'V': 7, 'VI': 9, 'VII': 11,
                'i': 0, 'ii': 2, 'iii': 4, 'iv': 5, 'v': 7, 'vi': 9, 'vii': 11,
                'I7': 0, 'II7': 2, 'III7': 4, 'IV7': 5, 'V7': 7, 'VI7': 9, 'VII7': 11,
                'i7': 0, 'ii7': 2, 'iii7': 4, 'iv7': 5, 'v7': 7, 'vi7': 9, 'vii7': 11,
                'Im7': 0, 'IIm7': 2, 'IIIm7': 4, 'IVm7': 5, 'Vm7': 7, 'VIm7': 9, 'VIIm7': 11,
                'Imaj7': 0, 'IImaj7': 2, 'IIImaj7': 4, 'IVmaj7': 5, 'Vmaj7': 7, 'VImaj7': 9, 'VIImaj7': 11,
                'Imaj6': 0, 'IImaj6': 2, 'IIImaj6': 4, 'IVmaj6': 5, 'Vmaj6': 7, 'VImaj6': 9, 'VIImaj6': 11,
                'I9': 0, 'II9': 2, 'III9': 4, 'IV9': 5, 'V9': 7, 'VI9': 9, 'VII9': 11,
                'I13': 0, 'II13': 2, 'III13': 4, 'IV13': 5, 'V13': 7, 'VI13': 9, 'VII13': 11,
                'V7b9': 7, 'V7#9': 7, 'V7b13': 7, 'V7#11': 7,
                'vii°': 11, 'ii°': 2, 'iii°': 4,
                'vii∅7': 11, 'ii∅7': 2, 'iii∅7': 4,
                'bII': 1, 'bIII': 3, 'bV': 6, 'bVI': 8, 'bVII': 10,
                'bII7': 1, 'bIII7': 3, 'bV7': 6, 'bVI7': 8, 'bVII7': 10,
                'bIImaj7': 1, 'bIIImaj7': 3, 'bVmaj7': 6, 'bVImaj7': 8, 'bVIImaj7': 10
            },
            minor: {
                'i': 0, 'ii': 2, 'III': 3, 'iv': 5, 'v': 7, 'VI': 8, 'VII': 10,
                'i°': 0, 'ii°': 2, 'III+': 3, 'iv°': 5, 'v°': 7, 'VI+': 8, 'vii°': 11,
                'i7': 0, 'ii7': 2, 'III7': 3, 'iv7': 5, 'v7': 7, 'VI7': 8, 'VII7': 10,
                'im7': 0, 'iim7': 2, 'IIIm7': 3, 'ivm7': 5, 'vm7': 7, 'VIm7': 8, 'VIIm7': 10,
                'imaj7': 0, 'iimaj7': 2, 'IIImaj7': 3, 'ivmaj7': 5, 'vmaj7': 7, 'VImaj7': 8, 'VIImaj7': 10,
                'iø7': 0, 'iiø7': 2, 'IIIø7': 3, 'ivø7': 5, 'vø7': 7, 'VIø7': 8, 'VIIø7': 10,
                'i°7': 0, 'ii°7': 2, 'III°7': 3, 'iv°7': 5, 'v°7': 7, 'VI°7': 8, 'VII°7': 10,
                'iim7b5': 2, 'iiim7b5': 4, 'vim7b5': 9,
                'i9': 0, 'ii9': 2, 'III9': 3, 'iv9': 5, 'v9': 7, 'VI9': 8, 'VII9': 10,
                'i13': 0, 'ii13': 2, 'III13': 3, 'iv13': 5, 'v13': 7, 'VI13': 8, 'VII13': 10,
                'V7b9': 7, 'V7#9': 7, 'V7b13': 7, 'V7#11': 7,
                'bII': 1, 'bIII': 3, 'bIV': 4, 'bV': 6, 'bVI': 8, 'bVII': 10,
                'bII7': 1, 'bIII7': 3, 'bIV7': 4, 'bV7': 6, 'bVI7': 8, 'bVII7': 10,
                'bIImaj7': 1, 'bIIImaj7': 3, 'bIVmaj7': 4, 'bVmaj7': 6, 'bVImaj7': 8, 'bVIImaj7': 10,
                'V7/III': 7, 'V7/iv': 7, 'V7/v': 7, 'V7/VI': 7, 'V7/VII': 7,
                'V7/bIII': 7, 'V7/bVI': 7, 'V7/bVII': 7
            }
        };

        // State Management
        const AppState = {
            isPlaying: false,
            currentBeat: 0,
            currentMeasure: 0,
            tempo: 120,
            audioInitialized: false,
            darkMode: false,
            listeners: [],
            updateState(newState) {
                Object.assign(this, newState);
                this.notifyListeners();
            },
            addListener(callback) {
                this.listeners.push(callback);
            },
            notifyListeners() {
                this.listeners.forEach(callback => callback(this));
            }
        };

        // UI Management
        const UI = {
            elements: {
                chordFretboard: document.getElementById('chord-fretboard'),
                measures: document.getElementById('measures'),
                tempoDisplay: document.getElementById('tempo-display'),
                startStopButton: document.getElementById('start-stop'),
                progressionSelect: document.getElementById('progression-select'),
                keySelect: document.getElementById('keySelect'),
                scaleDisplay: document.getElementById('scale-display'),
                chordTuning: document.getElementById('chord-tuning'),
                timeSignature: document.getElementById('time-signature'),
                soundType: document.getElementById('sound-type'),
                metronomeVolume: document.getElementById('metronome-volume'),
                tempo: document.getElementById('tempo'),
                tapTempo: document.getElementById('tap-tempo'),
                chordFretboardVolume: document.getElementById('chord-fretboard-volume'),
                chordVolume: document.getElementById('chord-volume'),
                chordsEnabled: document.getElementById('chordsEnabled'),
                fretboardVolume: document.getElementById('fretboard-volume'),
                fretboardsGrid: document.querySelector('.fretboards-grid'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                accentIntensity: document.getElementById('accent-intensity')
            },
            init() {
                Object.entries(this.elements).forEach(([key, el]) => {
                    if (!el) console.warn(`Missing DOM element: ${key}`);
                });
            }
        };

        // Audio Management
        const AudioContextManager = {
            context: null,
            soundBuffers: {},
            pianoSampleBuffers: {},
            reverbNode: null,
            samplesLoaded: false,
            currentChordGain: null,
            async initialize() {
                if (!this.context) {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    await this.loadSounds();
                    await this.loadPianoSamples();
                    await this.setupReverb();
                }
                if (this.context.state === 'suspended') {
                    await this.context.resume();
                }
                AppState.updateState({ audioInitialized: true });
                return this.context;
            },
            async ensureAudioContext() {
                return await this.initialize();
            },
            async loadSounds() {
                const soundFiles = {
                    'click': 'Click.wav',
                    'hihat': 'HiHat.wav',
                    'kick': 'Kick.wav',
                    'snare': 'Snare.wav',
                    'woodblock': 'woodblock.wav',
                    'jazzkick': 'jazzkick.wav',
                    'jazzsnare': 'jazzsnare.wav',
                    'jazzhat': 'jazzhat.wav'
                };
                for (let [type, filename] of Object.entries(soundFiles)) {
                    try {
                        const response = await fetch(`./${filename}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const arrayBuffer = await response.arrayBuffer();
                        this.soundBuffers[type] = await this.context.decodeAudioData(arrayBuffer);
                        log(`Loaded ${type} sound from ${filename}`);
                    } catch (error) {
                        console.error(`Failed to load ${filename}:`, error);
                        this.soundBuffers[type] = await this.createDrumSound(type);
                        log(`Using fallback synthetic sound for ${type}`);
                    }
                }
                updateLoadingStatus("Drum sounds loaded");
            },
            async createDrumSound(type) {
                const sampleRate = this.context.sampleRate;
                const duration = type === 'hihat' ? 0.05 : 0.2;
                const buffer = this.context.createBuffer(1, sampleRate * duration, sampleRate);
                const data = buffer.getChannelData(0);
                switch (type) {
                    case 'click':
                        for (let i = 0; i < data.length; i++) data[i] = Math.sin(i * 0.05) * Math.exp(-i * 0.01);
                        break;
                    case 'hihat':
                        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * 0.01));
                        break;
                    case 'kick':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = Math.sin(2 * Math.PI * 100 * t) * Math.exp(-t * 10) * 2;
                        }
                        break;
                    case 'snare':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = ((Math.random() * 2 - 1) + Math.sin(2 * Math.PI * 200 * t)) * Math.exp(-t * 10) * 2;
                        }
                        break;
                    case 'woodblock':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = Math.sin(2 * Math.PI * 800 * t) * Math.exp(-t * 20);
                        }
                        break;
                    case 'jazzkick':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = Math.sin(2 * Math.PI * 80 * t) * Math.exp(-t * 12) * 1.5;
                        }
                        break;
                    case 'jazzsnare':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = ((Math.random() * 1.5 - 0.75) + Math.sin(2 * Math.PI * 180 * t)) * Math.exp(-t * 8) * 1.5;
                        }
                        break;
                    case 'jazzhat':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = (Math.random() * 1.5 - 0.75) * Math.exp(-t * 50) * 0.8;
                        }
                        break;
                }
                return buffer;
            },
            async loadPianoSamples() {
                log('Starting piano sample loading...');
                if (!this.context) {
                    await this.initialize();
                }
                for (let note of SAMPLED_NOTES) {
                    for (let octave of PIANO_CONFIG.octaves[note]) {
                        const sampleName = `${note}${octave}v12`;
                        try {
                            const response = await fetch(`./${sampleName}.${PIANO_CONFIG.fileFormat}`);
                            if (!response.ok) throw new Error(`Failed to load ${sampleName}`);
                            const arrayBuffer = await response.arrayBuffer();
                            this.pianoSampleBuffers[sampleName] = await this.context.decodeAudioData(arrayBuffer);
                            log(`Loaded piano sample: ${sampleName}`);
                        } catch (error) {
                            console.warn(`Could not load ${sampleName}, using fallback`, error);
                            this.pianoSampleBuffers[sampleName] = this.createSyntheticSample(note, octave);
                        }
                    }
                }
                this.samplesLoaded = true;
                updateLoadingStatus("Piano samples loaded");
            },
            createSyntheticSample(note, octave) {
                const buffer = this.context.createBuffer(1, this.context.sampleRate, this.context.sampleRate);
                const data = buffer.getChannelData(0);
                const frequency = PIANO_NOTES[`${note}${octave}`] || 440;
                for (let i = 0; i < data.length; i++) {
                    data[i] = Math.sin(2 * Math.PI * frequency * i / this.context.sampleRate) * Math.exp(-i / this.context.sampleRate);
                }
                return buffer;
            },
            async setupReverb() {
                if (!this.reverbNode) {
                    this.reverbNode = this.context.createConvolver();
                    const sampleRate = this.context.sampleRate;
                    const length = sampleRate * 2.5;
                    const impulse = this.context.createBuffer(2, length, sampleRate);
                    for (let channel = 0; channel < 2; channel++) {
                        const channelData = impulse.getChannelData(channel);
                        for (let i = 0; i < length; i++) {
                            channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2);
                        }
                    }
                    this.reverbNode.buffer = impulse;
                    this.reverbNode.connect(this.context.destination);
                }
            }
        };

        async function ensureAudioInitialized() {
            if (!AudioContextManager.context || AudioContextManager.context.state === 'suspended') {
                try {
                    await AudioContextManager.initialize();
                    if (AudioContextManager.context.state === 'suspended') {
                        await AudioContextManager.context.resume();
                    }
                } catch (error) {
                    console.error('Audio initialization failed:', error);
                    alert('Please click anywhere on the page to enable audio playback');
                    throw error;
                }
            }
        }

        // Music Theory Utilities
        function getNoteFromScaleDegree(degree, key, scale) {
            const chromaticScale = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
            const keyIndex = chromaticScale.indexOf(standardizeNoteName(key));
            if (keyIndex === -1) return null;
            const noteIndex = (keyIndex + scale[degree]) % 12;
            const note = chromaticScale[noteIndex];
            return flattenNote(note);
        }

        function standardizeNoteName(note) {
            if (!note) return 'C';
            const isMinor = note.trim().endsWith('m') || note.trim().endsWith('min');
            const baseNote = note.trim().replace(/m$|min$/, '');
            const standardized = ENHARMONIC_MAP[baseNote] || baseNote;
            return isMinor ? standardized + 'm' : standardized;
        }

        function getNoteIndex(note) {
            const standardizedNote = standardizeNoteName(note);
            return NOTES.indexOf(standardizedNote);
        }

        const MIN_OCTAVE = 2;
        const MAX_OCTAVE = 4;

        function findNearestSampledNote(noteName, octave) {
            const cleanNote = standardizeNoteName(noteName).replace('m', '');
            const mappedNote = ENHARMONIC_MAP[cleanNote] || cleanNote;
            const sampleNote = SAMPLE_NOTE_MAP[mappedNote] || mappedNote;

            if (!SAMPLED_NOTES.includes(sampleNote)) {
                console.warn(`Sample note ${sampleNote} not available.`);
                return null;
            }

            const availableOctaves = PIANO_CONFIG.octaves[sampleNote];
            let targetOctave = Math.max(MIN_OCTAVE, Math.min(MAX_OCTAVE, octave));

            if (!availableOctaves.includes(targetOctave)) {
                targetOctave = availableOctaves.reduce((closest, curr) => {
                    return Math.abs(curr - octave) < Math.abs(closest - octave) ? curr : closest;
                }, availableOctaves[0]);
            }

            const sampleKey = `${sampleNote}${targetOctave}v12`;
            const sampleFrequency = PIANO_NOTES[`${sampleNote}${targetOctave}`] || 440;
            const targetFrequency = PIANO_NOTES[`${cleanNote}${octave}`] || sampleFrequency;
            const playbackRate = targetFrequency / sampleFrequency;

            return { sampleKey, playbackRate };
        }

        function parseChord(chord) {
            if (!chord || typeof chord !== 'string') return ['C', 'major'];
            const match = chord.match(/^([A-G][b#]?)(.*)$/);
            if (!match) return ['C', 'major'];
            let [, root, quality] = match;
            root = standardizeNoteName(root);
            quality = quality.toLowerCase().replace(/min|m$/, 'minor').replace(/maj7/, 'maj7').replace(/m7/, 'min7').replace(/7/, 'dom7').replace(/ø7/, 'min7b5').replace(/^m6/, 'm6').replace(/^6/, '6');
            return [root, INTERVAL_MAP[quality] ? quality : 'major'];
        }

        function getChordFromFunction(func, key) {
            if (!func || !key) return 'C';
            const isMinor = key.endsWith('m');
            const mode = isMinor ? 'minor' : 'major';
            const keyRoot = standardizeNoteName(key.replace('m', ''));
            const degreeMatch = func.match(/^([b#]?[ivIV]+)(.*)$/);
            if (!degreeMatch) return keyRoot;
            const [, degree, quality] = degreeMatch;
            const degreeMap = scaleDegrees[mode];
            const degreeKey = `${degree}${quality || ''}`;
            const interval = degreeMap[degreeKey] || degreeMap[degree] || 0;
            const rootIndex = NOTES.indexOf(keyRoot);
            const noteIndex = (rootIndex + interval) % 12;
            let root = NOTES[noteIndex];
            let chordQuality = 'major';
            if (quality) {
                if (quality.includes('m7') || quality.includes('min7')) chordQuality = 'min7';
                else if (quality.includes('maj7')) chordQuality = 'maj7';
                else if (quality.includes('7')) chordQuality = 'dom7';
                else if (quality.includes('m6')) chordQuality = 'm6';
                else if (quality.includes('6')) chordQuality = '6';
                else if (quality.includes('m') || quality.includes('min')) chordQuality = 'minor';
                else if (quality.includes('dim') || quality.includes('°')) chordQuality = 'dim';
                else if (quality.includes('aug') || quality.includes('+')) chordQuality = 'aug';
                else if (quality.includes('sus4')) chordQuality = 'sus4';
                else if (quality.includes('sus2')) chordQuality = 'sus2';
                else if (quality.includes('m7b5') || quality.includes('ø7')) chordQuality = 'min7b5';
                else if (quality.includes('dim7')) chordQuality = 'dim7';
                else if (quality.includes('9')) chordQuality = '9';
                else if (quality.includes('maj9')) chordQuality = 'maj9';
                else if (quality.includes('min9')) chordQuality = 'min9';
            } else {
                const roman = degree.toLowerCase();
                if (mode === 'major') {
                    if (['ii', 'iii', 'vi'].includes(roman)) chordQuality = 'minor';
                    else if (roman === 'vii') chordQuality = 'dim';
                } else if (mode === 'minor') {
                    if (['iii', 'vi', 'vii'].includes(roman)) chordQuality = 'major';
                    else if (roman === 'ii') chordQuality = 'dim';
                    else if (['iv', 'v'].includes(roman)) chordQuality = 'minor';
                }
            }
            return `${root}${chordQuality === 'major' ? '' : chordQuality}`;
        }

        function createKeyOptions(selected) {
            return NOTES.map(note => `<option value="${note}" ${note === selected ? 'selected' : ''}>${note}</option>`).join('');
        }

        function createQualityOptions(selected) {
            const qualities = Object.keys(INTERVAL_MAP);
            return qualities.map(quality => `<option value="${quality}" ${quality === selected ? 'selected' : ''}>${quality}</option>`).join('');
        }

        function createScaleOptions(selected) {
            const scales = Object.keys(SCALES);
            return scales.map(scale => `<option value="${scale}" ${scale === selected ? 'selected' : ''}>${scale.charAt(0).toUpperCase() + scale.slice(1)}</option>`).join('');
        }

        function suggestScaleForQuality(quality) {
            switch (quality) {
                case 'dom7': return 'mixolydian';
                case 'maj7': return 'major';
                case 'min7': return 'dorian';
                case 'min7b5': return 'locrian';
                case 'minor': return 'minor';
                case 'm6': return 'dorian';
                case '6': return 'major';
                default: return 'major';
            }
        }

        function getQualityValue(quality) {
            switch (quality) {
                case '7': return 'dom7';
                case 'm7': return 'min7';
                case 'm': return 'minor';
                case 'ø7': return 'min7b5';
                default: return quality;
            }
        }

        function getChordNotes(chord) {
            const [root, quality] = parseChord(chord);
            if (!root || !NOTES.includes(root)) {
                console.warn(`Invalid root note: ${root}`);
                return [];
            }
            const intervals = INTERVAL_MAP[quality] || INTERVAL_MAP['major'];
            return intervals.map(interval => {
                const rootIndex = NOTES.indexOf(root);
                const noteIndex = (rootIndex + interval) % 12;
                const noteName = NOTES[noteIndex];
                const octave = Math.floor((rootIndex + interval) / 12) + 3;
                return noteName + octave;
            }).filter(note => {
                if (!note.match(/^[A-G][b#]?[2-4]$/)) {
                    console.warn(`Generated invalid note: ${note}`);
                    return false;
                }
                return true;
            });
        }

        async function playNote(stringOrNote, fretOrVolume, duration = 500) {
            try {
                await AudioContextManager.ensureAudioContext();
                let note, volume;

                if (typeof stringOrNote === 'string' && stringOrNote.startsWith('string')) {
                    const string = parseInt(stringOrNote.replace('string', '')) - 1;
                    const fret = parseInt(fretOrVolume);
                    if (isNaN(string) || string < 0 || string > 5 || isNaN(fret) || fret < 0 || fret >= FRETBOARD_FREQUENCIES[`string${string + 1}`].length) {
                        console.warn(`Invalid string or fret: string=${stringOrNote}, fret=${fretOrVolume}`);
                        return;
                    }
                    const frequency = FRETBOARD_FREQUENCIES[`string${string + 1}`][fret];
                    const noteEntry = Object.entries(PIANO_NOTES).find(([_, freq]) => Math.abs(freq - frequency) < 0.1);
                    if (!noteEntry) {
                        console.warn(`No note found for frequency: ${frequency}`);
                        return;
                    }
                    note = noteEntry[0];
                    volume = parseFloat(UI.elements.chordFretboardVolume.value) || 0.3;
                } else {
                    note = stringOrNote;
                    volume = typeof fretOrVolume === 'number' ? fretOrVolume : parseFloat(UI.elements.chordFretboardVolume.value) || 0.3;
                }

                if (!note || !note.match(/^[A-G][b#]?[2-4]$/)) {
                    console.warn(`Invalid note format: ${note}`);
                    return;
                }

                const [noteName, octave] = note.match(/^([A-G][b#]?)([2-4])$/).slice(1);
                const sampleInfo = findNearestSampledNote(noteName, parseInt(octave));
                if (!sampleInfo) {
                    console.warn(`No sample found for note: ${note}`);
                    return;
                }

                const { sampleKey, playbackRate } = sampleInfo;
                const buffer = AudioContextManager.pianoSampleBuffers[sampleKey];
                if (!buffer) {
                    console.warn(`No buffer for sample: ${sampleKey}`);
                    return;
                }

                const source = AudioContextManager.context.createBufferSource();
                source.buffer = buffer;
                source.playbackRate.value = playbackRate;

                const gainNode = AudioContextManager.context.createGain();
                gainNode.gain.setValueAtTime(volume, AudioContextManager.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, AudioContextManager.context.currentTime + duration / 1000);

                source.connect(gainNode);
                gainNode.connect(AudioContextManager.reverbNode);
                source.start();
                source.stop(AudioContextManager.context.currentTime + duration / 1000);
            } catch (error) {
                console.error(`Error playing note ${stringOrNote}:`, error);
            }
        }

        async function playChord(chord, duration = 1000) {
            try {
                await AudioContextManager.ensureAudioContext();
                if (AudioContextManager.currentChordGain) {
                    AudioContextManager.currentChordGain.gain.setValueAtTime(0, AudioContextManager.context.currentTime);
                    AudioContextManager.currentChordGain = null;
                }

                const chordVolume = parseFloat(UI.elements.chordVolume.value) || 0.75;
                const notes = getChordNotes(chord);
                if (!notes.length) {
                    console.warn(`No valid notes for chord: ${chord}`);
                    return;
                }

                const gainNode = AudioContextManager.context.createGain();
                gainNode.gain.setValueAtTime(chordVolume, AudioContextManager.context.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, AudioContextManager.context.currentTime + duration / 1000);
                gainNode.connect(AudioContextManager.reverbNode);
                AudioContextManager.currentChordGain = gainNode;

                for (const note of notes) {
                    const [noteName, octave] = note.match(/^([A-G][b#]?)([2-4])$/).slice(1);
                    const sampleInfo = findNearestSampledNote(noteName, parseInt(octave));
                    if (!sampleInfo) continue;

                    const { sampleKey, playbackRate } = sampleInfo;
                    const buffer = AudioContextManager.pianoSampleBuffers[sampleKey];
                    if (!buffer) continue;

                    const source = AudioContextManager.context.createBufferSource();
                    source.buffer = buffer;
                    source.playbackRate.value = playbackRate;
                    source.connect(gainNode);
                    source.start();
                    source.stop(AudioContextManager.context.currentTime + duration / 1000);
                }
            } catch (error) {
                console.error(`Error playing chord ${chord}:`, error);
            }
        }

        // Fretboard Management
        function createFretboard(fretboardElement, tuning = 'standard', scale = 'major', key = 'C', chord = null) {
            if (!fretboardElement) {
                console.error('Fretboard element not found');
                return;
            }
            fretboardElement.innerHTML = '';

            const numFrets = 12;
            const numStrings = 6;
            const fretWidth = 100 / (numFrets + 1);
            const stringHeight = 100 / (numStrings + 1);

            for (let fret = 0; fret <= numFrets; fret++) {
                const fretLine = document.createElement('div');
                fretLine.className = 'fret-line';
                fretLine.style.left = `${fret * fretWidth}%`;
                fretboardElement.appendChild(fretLine);

                if (fret > 0) {
                    const fretNumber = document.createElement('div');
                    fretNumber.className = 'fret-number';
                    fretNumber.textContent = fret;
                    fretNumber.style.left = `${fret * fretWidth - fretWidth / 2}%`;
                    fretboardElement.appendChild(fretNumber);
                }
            }

            for (let string = 0; string < numStrings; string++) {
                const stringLine = document.createElement('div');
                stringLine.className = 'string-line';
                stringLine.style.top = `${(string + 1) * stringHeight}%`;
                fretboardElement.appendChild(stringLine);
            }

            const fretMarkers = [
                { fret: 3, string: 3.5 },
                { fret: 5, string: 3.5 },
                { fret: 7, string: 3.5 },
                { fret: 9, string: 3.5 },
                { fret: 12, string: 2.5 },
                { fret: 12, string: 4.5 }
            ];
            fretMarkers.forEach(marker => {
                const fretMarker = document.createElement('div');
                fretMarker.className = 'fret-marker';
                fretMarker.style.left = `${(marker.fret - 0.5) * fretWidth}%`;
                fretMarker.style.top = `${marker.string * stringHeight}%`;
                fretboardElement.appendChild(fretMarker);
            });

        function updateFretboardNotes(fretboardElement, tuning, scale, key, chord = null) {
            if (!fretboardElement) return;
            const existingNotes = fretboardElement.querySelectorAll('.note');
            existingNotes.forEach(note => note.remove());
    
            const numFrets = 12;
            const numStrings = 6;
            const fretWidth = 100 / (numFrets + 1);
            const stringHeight = 100 / (numStrings + 1);
            const tuningNotes = TUNINGS[tuning] || TUNINGS.standard;
            const scaleIntervals = SCALES[scale] || SCALES.major;
            const keyIndex = NOTES.indexOf(standardizeNoteName(key));
            const scaleNotes = scaleIntervals.map(interval => NOTES[(keyIndex + interval) % 12]);
            let chordNotes = [];
            if (chord) {
                chordNotes = getChordNotes(chord).map(note => note.replace(/[2-4]$/, ''));
            }
    
            for (let string = 0; string < numStrings; string++) {
                const openNote = standardizeNoteName(tuningNotes[numStrings - 1 - string]);
                const openNoteIndex = NOTES.indexOf(openNote);
                for (let fret = 0; fret <= numFrets; fret++) {
                    const noteIndex = (openNoteIndex + fret) % 12;
                    const noteName = NOTES[noteIndex];
                    if (scaleNotes.includes(noteName) || (chord && chordNotes.includes(noteName))) {
                        const noteElement = document.createElement('div');
                        noteElement.className = 'note';
                        noteElement.textContent = noteName;
                        noteElement.style.left = `${fret * fretWidth + fretWidth / 2}%`;
                        noteElement.style.top = `${(string + 1) * stringHeight}%`;
                        noteElement.style.backgroundColor = chord && chordNotes.includes(noteName) ? '#e74c3c' : '#2ecc71';
                        noteElement.dataset.string = `string${numStrings - string}`;
                        noteElement.dataset.fret = fret;
                        noteElement.addEventListener('click', async () => {
                            await playNote(noteElement.dataset.string, noteElement.dataset.fret);
                        });
                        fretboardElement.appendChild(noteElement);
                    }
                }
            }
        }
    
        // Metronome Management
        let metronomeInterval = null;
        let lastTapTime = 0;
        let tapTimes = [];
    
        function updateBeatsContainer() {
            const beatsContainer = document.querySelector('.beats-container');
            beatsContainer.innerHTML = '';
            const beats = parseInt(UI.elements.timeSignature.value);
            for (let i = 0; i < beats; i++) {
                const beat = document.createElement('div');
                beat.className = 'beat';
                beat.textContent = i + 1;
                beat.dataset.accent = i === 0 ? 'true' : 'false';
                beat.addEventListener('click', () => {
                    beat.dataset.accent = beat.dataset.accent === 'true' ? 'false' : 'true';
                    beat.style.background = beat.dataset.accent === 'true' ? '#e74c3c' : '#9E9E9E';
                });
                beatsContainer.appendChild(beat);
            }
        }
    
        async function playMetronomeSound(beatIndex) {
            await AudioContextManager.ensureAudioContext();
            const soundType = UI.elements.soundType.value;
            const volume = parseFloat(UI.elements.metronomeVolume.value) || 0.25;
            const accentIntensity = parseFloat(UI.elements.accentIntensity.value) || 1.5;
            const beats = document.querySelectorAll('.beat');
            const isAccent = beats[beatIndex] && beats[beatIndex].dataset.accent === 'true';
            let soundKey = soundType;
            if (soundType === 'drums') {
                const timeSig = UI.elements.timeSignature.value;
                const pattern = DRUM_PATTERNS[timeSig] || DRUM_PATTERNS['4'];
                const currentDrumSet = drumSoundSets[currentDrumSetIndex];
                const beatInPattern = beatIndex % pattern.hihat.length;
                if (pattern.kick[beatInPattern]) soundKey = currentDrumSet.kick.replace('.wav', '');
                else if (pattern.snare[beatInPattern]) soundKey = currentDrumSet.snare.replace('.wav', '');
                else soundKey = currentDrumSet.hihat.replace('.wav', '');
            }
            const buffer = AudioContextManager.soundBuffers[soundKey];
            if (!buffer) return;
            const source = AudioContextManager.context.createBufferSource();
            source.buffer = buffer;
            const gainNode = AudioContextManager.context.createGain();
            gainNode.gain.setValueAtTime(isAccent ? volume * accentIntensity : volume, AudioContextManager.context.currentTime);
            source.connect(gainNode);
            gainNode.connect(AudioContextManager.context.destination);
            source.start();
        }
    
        function startMetronome() {
            if (AppState.isPlaying) return;
            const tempo = parseInt(UI.elements.tempo.value) || 120;
            const interval = 60000 / tempo;
            AppState.updateState({ isPlaying: true, currentBeat: 0, currentMeasure: 0 });
            UI.elements.startStopButton.textContent = 'Stop';
            metronomeInterval = setInterval(async () => {
                const beats = parseInt(UI.elements.timeSignature.value);
                await playMetronomeSound(AppState.currentBeat);
                const beatElements = document.querySelectorAll('.beat');
                beatElements.forEach((beat, i) => {
                    beat.classList.toggle('active', i === AppState.currentBeat);
                });
                AppState.currentBeat = (AppState.currentBeat + 1) % beats;
                if (AppState.currentBeat === 0) {
                    AppState.currentMeasure = (AppState.currentMeasure + 1) % UI.elements.measures.children.length;
                    updateChordProgression();
                }
            }, interval);
        }
    
        function stopMetronome() {
            if (!AppState.isPlaying) return;
            clearInterval(metronomeInterval);
            AppState.updateState({ isPlaying: false, currentBeat: 0, currentMeasure: 0 });
            UI.elements.startStopButton.textContent = 'Start';
            document.querySelectorAll('.beat').forEach(beat => beat.classList.remove('active'));
            updateChordProgression();
        }
    
        function updateChordProgression() {
            const measures = UI.elements.measures.children;
            Array.from(measures).forEach((measure, index) => {
                measure.classList.toggle('active', index === AppState.currentMeasure);
                if (index === AppState.currentMeasure && AppState.isPlaying && UI.elements.chordsEnabled.classList.contains('active')) {
                    const chordSelect = measure.querySelector('.chord-select');
                    if (chordSelect) {
                        const chord = chordSelect.value;
                        playChord(chord, 60000 / (parseInt(UI.elements.tempo.value) || 120));
                        const scale = suggestScaleForQuality(parseChord(chord)[1]);
                        updateFretboardNotes(UI.elements.chordFretboard, UI.elements.chordTuning.value, scale, parseChord(chord)[0], chord);
                        UI.elements.scaleDisplay.textContent = `${parseChord(chord)[0]} ${scale.charAt(0).toUpperCase() + scale.slice(1)}`;
                    }
                }
            });
        }
    
        // Chord Progression Management
        function createMeasure(chord = 'C', quality = 'major', scale = 'major', key = 'C') {
            const measure = document.createElement('div');
            measure.className = 'measure';
            measure.draggable = true;
            measure.innerHTML = `
                <span class="measure-number"></span>
                <div class="chord-controls">
                    <select class="chord-select" aria-label="Select chord">
                        ${createKeyOptions(chord)}
                    </select>
                    <select class="quality-select" aria-label="Select chord quality">
                        ${createQualityOptions(quality)}
                    </select>
                </div>
                <div class="scale-controls">
                    <select class="scale-select" aria-label="Select scale">
                        ${createScaleOptions(scale)}
                    </select>
                    <select class="scale-key-select" aria-label="Select scale key">
                        ${createKeyOptions(key)}
                    </select>
                </div>
            `;
            const chordSelect = measure.querySelector('.chord-select');
            const qualitySelect = measure.querySelector('.quality-select');
            const scaleSelect = measure.querySelector('.scale-select');
            const scaleKeySelect = measure.querySelector('.scale-key-select');
    
            chordSelect.addEventListener('change', () => {
                const chord = `${chordSelect.value}${qualitySelect.value === 'major' ? '' : qualitySelect.value}`;
                const suggestedScale = suggestScaleForQuality(qualitySelect.value);
                scaleSelect.value = suggestedScale;
                updateFretboardNotes(UI.elements.chordFretboard, UI.elements.chordTuning.value, suggestedScale, chordSelect.value, chord);
                UI.elements.scaleDisplay.textContent = `${chordSelect.value} ${suggestedScale.charAt(0).toUpperCase() + suggestedScale.slice(1)}`;
            });
    
            qualitySelect.addEventListener('change', () => {
                const chord = `${chordSelect.value}${qualitySelect.value === 'major' ? '' : qualitySelect.value}`;
                const suggestedScale = suggestScaleForQuality(qualitySelect.value);
                scaleSelect.value = suggestedScale;
                updateFretboardNotes(UI.elements.chordFretboard, UI.elements.chordTuning.value, suggestedScale, chordSelect.value, chord);
                UI.elements.scaleDisplay.textContent = `${chordSelect.value} ${suggestedScale.charAt(0).toUpperCase() + suggestedScale.slice(1)}`;
            });
    
            scaleSelect.addEventListener('change', () => {
                updateFretboardNotes(UI.elements.chordFretboard, UI.elements.chordTuning.value, scaleSelect.value, scaleKeySelect.value);
                UI.elements.scaleDisplay.textContent = `${scaleKeySelect.value} ${scaleSelect.value.charAt(0).toUpperCase() + scaleSelect.slice(1)}`;
            });
    
            scaleKeySelect.addEventListener('change', () => {
                updateFretboardNotes(UI.elements.chordFretboard, UI.elements.chordTuning.value, scaleSelect.value, scaleKeySelect.value);
                UI.elements.scaleDisplay.textContent = `${scaleKeySelect.value} ${scaleSelect.value.charAt(0).toUpperCase() + scaleSelect.slice(1)}`;
            });
    
            measure.addEventListener('dragstart', (e) => {
                measure.classList.add('dragging');
                e.dataTransfer.setData('text/plain', Array.from(UI.elements.measures.children).indexOf(measure));
            });
    
            measure.addEventListener('dragend', () => {
                measure.classList.remove('dragging');
            });
    
            measure.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
    
            measure.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const dropIndex = Array.from(UI.elements.measures.children).indexOf(measure);
                const measuresArray = Array.from(UI.elements.measures.children);
                const draggedMeasure = measuresArray[draggedIndex];
                if (draggedIndex < dropIndex) {
                    UI.elements.measures.insertBefore(draggedMeasure, measure.nextSibling);
                } else {
                    UI.elements.measures.insertBefore(draggedMeasure, measure);
                }
                updateMeasureNumbers();
            });
    
            return measure;
        }
    
        function addMeasure() {
            const measure = createMeasure();
            UI.elements.measures.appendChild(measure);
            updateMeasureNumbers();
        }
    
        function removeMeasure() {
            if (UI.elements.measures.children.length > 1) {
                UI.elements.measures.removeChild(UI.elements.measures.lastChild);
                updateMeasureNumbers();
            }
        }
    
        function updateMeasureNumbers() {
            Array.from(UI.elements.measures.children).forEach((measure, index) => {
                const number = measure.querySelector('.measure-number');
                number.textContent = index + 1;
            });
        }
    
        function loadProgression() {
            const progressionName = UI.elements.progressionSelect.value;
            const progressionData = progressions[progressionName] || progressions['I V7'];
            const key = UI.elements.keySelect.value || progressionData.defaultKey;
            UI.elements.measures.innerHTML = '';
            progressionData.progression.forEach(chordFunc => {
                const chord = getChordFromFunction(chordFunc, key);
                const [root, quality] = parseChord(chord);
                const scale = suggestScaleForQuality(quality);
                const measure = createMeasure(root, quality, scale, root);
                UI.elements.measures.appendChild(measure);
            });
            updateMeasureNumbers();
            updateChordProgression();
        }
    
        // FretFlow Section
        function initializeFretFlow() {
            const scalesToDisplay = ['major', 'minor', 'bebopDominant', 'blues'];
            UI.elements.fretboardsGrid.innerHTML = '';
            scalesToDisplay.forEach(scale => {
                const container = document.createElement('div');
                container.className = 'fretboard-container';
                const scaleDisplay = document.createElement('div');
                scaleDisplay.className = 'scale-display';
                scaleDisplay.textContent = `C ${scale.charAt(0).toUpperCase() + scale.slice(1)}`;
                const fretboard = document.createElement('div');
                fretboard.className = 'fretboard';
                container.appendChild(scaleDisplay);
                container.appendChild(fretboard);
                UI.elements.fretboardsGrid.appendChild(container);
                createFretboard(fretboard, 'standard', scale, 'C');
            });
        }
    
        // Event Listeners
function setupEventListeners() {
    UI.elements.chordTuning.addEventListener('change', () => {
        createFretboard(UI.elements.chordFretboard, UI.elements.chordTuning.value);
    });

    UI.elements.timeSignature.addEventListener('change', updateBeatsContainer);

    UI.elements.startStopButton.addEventListener('click', () => {
        if (AppState.isPlaying) {
            stopMetronome();
        } else {
            startMetronome();
        }
    });

    UI.elements.tempo.addEventListener('input', () => {
        const tempo = parseInt(UI.elements.tempo.value) || 120;
        UI.elements.tempoDisplay.textContent = `${tempo} BPM`;
        AppState.updateState({ tempo });
        if (AppState.isPlaying) {
            stopMetronome();
            startMetronome();
        }
    });

    UI.elements.tapTempo.addEventListener('click', () => {
        const now = Date.now();
        if (lastTapTime) {
            tapTimes.push(now - lastTapTime);
            if (tapTimes.length > 4) tapTimes.shift();
            const avgInterval = tapTimes.reduce((a, b) => a + b, 0) / tapTimes.length;
            const tempo = Math.round(60000 / avgInterval);
            UI.elements.tempo.value = tempo;
            UI.elements.tempoDisplay.textContent = `${tempo} BPM`;
            AppState.updateState({ tempo });
            if (AppState.isPlaying) {
                stopMetronome();
                startMetronome();
            }
        }
        lastTapTime = now;
    });

    UI.elements.progressionSelect.addEventListener('change', loadProgression);
    UI.elements.keySelect.addEventListener('change', loadProgression);

    UI.elements.chordsEnabled.addEventListener('click', () => {
        UI.elements.chordsEnabled.classList.toggle('active');
        UI.elements.chordsEnabled.textContent = UI.elements.chordsEnabled.classList.contains('active') ? 'Chords Enabled' : 'Chords Disabled';
    });

    UI.elements.darkModeToggle.addEventListener('click', () => {
        AppState.updateState({ darkMode: !AppState.darkMode });
        document.body.classList.toggle('dark-mode', AppState.darkMode);
        UI.elements.darkModeToggle.classList.toggle('active', AppState.darkMode);
        UI.elements.darkModeToggle.textContent = AppState.darkMode ? 'Light Mode' : 'Dark Mode';
    });

    UI.elements.drumSetToggleBtn.addEventListener('click', () => {
        currentDrumSetIndex = (currentDrumSetIndex + 1) % drumSoundSets.length;
        UI.elements.drumSetToggleBtn.textContent = drumSoundSets[currentDrumSetIndex].name;
    });
}
    
        // Initialization
        async function initializeApp() {
            try {
                UI.init();
                await AudioContextManager.initialize();
                createFretboard(UI.elements.chordFretboard, UI.elements.chordTuning.value);
                updateBeatsContainer();
                loadProgression();
                initializeFretFlow();
                setupEventListeners();
                updateLoadingStatus('App initialized');
            } catch (error) {
                console.error('Initialization failed:', error);
                updateLoadingStatus('Initialization failed');
            }
        }
    
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    </body>
    </html>
